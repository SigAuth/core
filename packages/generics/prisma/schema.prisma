// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/prisma-generated"

  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id           Int       @id @default(autoincrement())
  email        String?   @unique
  name         String    @unique
  api          String?   @unique // token
  secondFactor String?   @unique // token
  password     String
  sessions     Session[]
  accounts     Json      @default("[]") // number[]
  deactivated  Boolean   @default(false)

  permissions     PermissionInstance[]
  assetToAccounts AssetToAccount[]
}

// login session for the main idp
model Session {
  id String @id @unique

  subject Int
  expire  Int
  created Int

  account Account @relation(fields: [subject], references: [id])

  challenges AuthorizationChallenge[]
  instances  AuthorizationInstance[]
}

// currently active refresh tokens provided to third parties
model AuthorizationInstance {
  id        Int    @id @default(autoincrement())
  sessionId String
  appId     Int

  refreshToken       String @unique
  refreshTokenExpire Int

  app     App     @relation(fields: [appId], references: [id])
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// pending authorization codes
model AuthorizationChallenge {
  id        Int    @id @default(autoincrement())
  sessionId String
  appId     Int

  authorizationCode String   @unique
  challenge         String?  @unique
  redirectUri       String
  created           DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  app     App     @relation(fields: [appId], references: [id])
}

model PermissionInstance {
  id         Int    @id @default(autoincrement()) // this is only because an prim key is required but we can't form a consitent prim key from the fields below
  accountId  Int
  appId      Int
  identifier String
  assetId    Int? // null for container permission

  app     App     @relation(fields: [appId], references: [id])
  account Account @relation(fields: [accountId], references: [id])
  asset   Asset?  @relation(fields: [assetId], references: [id])

  @@unique([accountId, appId, identifier, assetId])
  // todo find our which indexes make the most sense
  @@index([accountId])
  @@index([accountId, appId])
  @@index([accountId, assetId])
  @@index([accountId, identifier])
}

// todo add roles and mirrors

enum ReferentialIntegrityStrategy {
  CASCADE
  RESTRICT
  SET_NULL
  INVALIDATE
}

model AssetType {
  id     Int     @id @default(autoincrement())
  name   String
  assets Asset[]

  assetTypeField AssetTypeField[]
  foreignFields  ReferencedFieldOnAssetType[]
}

model AssetTypeField {
  assetTypeId Int
  fieldId     Int @db.SmallInt()
  fieldTypeId Int @db.SmallInt()

  required Boolean @default(false)
  name     String

  // selector
  items String[]

  // relationships
  referentialIntegrityStrategy ReferentialIntegrityStrategy? @default(RESTRICT)
  allowMultipleRelations       Boolean                       @default(true)
  allowedAssetTypes            ReferencedFieldOnAssetType[]

  assetType AssetType? @relation(fields: [assetTypeId], references: [id])

  @@id([assetTypeId, fieldId])
}

model ReferencedFieldOnAssetType {
  assetTypeId Int
  fieldId     Int

  referencedAssetTypeId Int

  referencedAssetType AssetType      @relation(fields: [referencedAssetTypeId], references: [id])
  field               AssetTypeField @relation(fields: [assetTypeId, fieldId], references: [assetTypeId, fieldId])

  @@id([assetTypeId, fieldId, referencedAssetTypeId])
}

model Asset {
  id     Int       @id @default(autoincrement())
  name   String
  typeId Int
  fields Json
  type   AssetType @relation(fields: [typeId], references: [id])

  PermissionInstance PermissionInstance[]
  fromAssetToAssets  AssetToAsset[]       @relation("FromAsset")
  toAssetToAssets    AssetToAsset[]       @relation("ToAsset")
  assetToApps        AssetToApp[]
  assetToAccounts    AssetToAccount[]
}

model AssetToAsset {
  fromAssetId Int
  toAssetId   Int
  fieldId     Int

  fromAsset Asset @relation("FromAsset", fields: [fromAssetId], references: [id])
  toAsset   Asset @relation("ToAsset", fields: [toAssetId], references: [id])

  @@id([fromAssetId, toAssetId, fieldId])
  @@index([fromAssetId])
  @@index([toAssetId])
}

model AssetToApp {
  assetId Int
  appId   Int
  fieldId Int

  asset Asset @relation(fields: [assetId], references: [id])
  app   App   @relation(fields: [appId], references: [id])

  @@id([assetId, appId, fieldId])
  @@index([assetId])
  @@index([appId])
}

model AssetToAccount {
  assetId   Int
  accountId Int
  fieldId   Int

  asset   Asset   @relation(fields: [assetId], references: [id])
  account Account @relation(fields: [accountId], references: [id])

  @@id([assetId, accountId, fieldId])
  @@index([assetId])
  @@index([accountId])
}

model Mirror {
  id   Int    @id @default(autoincrement())
  name String
  code String

  autoRun         Boolean   @default(false)
  autoRunInterval Int? // in minutes
  lastRun         DateTime?
  lastResult      String?
}

model App {
  id              Int     @id @default(autoincrement())
  name            String
  url             String
  oidcAuthCodeUrl String?
  token           String  @unique
  permissions     Json
  webFetch        Json

  PermissionInstance     PermissionInstance[]
  AuthorizationChallenge AuthorizationChallenge[]
  AuthorizationInstance  AuthorizationInstance[]
  assetToApps            AssetToApp[]
}
